<!-- app/views/sessions/show.html.erb -->
<div class="container-fluid mt-4">
  <!-- Compact Header with Branding -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card shadow border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="card-body text-white py-3">
          <div class="row align-items-center">
            <!-- Left: Branding -->
            <div class="col-md-3 text-center text-md-start">
              <h4 class="mb-0" style="font-weight: 700; letter-spacing: 1px;">
                üé¨ <span style="color: #FFD700;">REEL</span> PARTY üéµ
              </h4>
              <small class="opacity-75">Collaborative Streaming</small>
            </div>
            
            <!-- Center: Session Info -->
            <div class="col-md-6 text-center">
              <% if @user_role == 'host' %>
                <div class="d-flex justify-content-center align-items-center flex-wrap">
                  <span class="badge bg-light text-dark me-2 mb-1">
                    üëë Host: <%= @session.host_name %>
                  </span>
                  <span class="badge bg-warning text-dark me-2 mb-1">
                    ID: <%= @session.id %>
                  </span>
                </div>
              <% else %>
                <div class="d-flex justify-content-center align-items-center">
                  <span class="badge bg-light text-dark me-2">
                    üé≠ Guest in: <%= @session.host_name %>
                  </span>
                  <% if @remote_listen %>
                    <span class="badge bg-success text-white">üéß Listening</span>
                  <% else %>
                    <span class="badge bg-info text-white">üìù Adding Only</span>
                  <% end %>
                </div>
              <% end %>
            </div>
            
            <!-- Right: Share Buttons (Host Only) -->
            <div class="col-md-3 text-center text-md-end">
              <% if @user_role == 'host' %>
                <div class="btn-group btn-group-sm" role="group">
                  <button class="btn btn-light btn-sm" onclick="copyToClipboard('<%= request.base_url %>/sessions/<%= @session.id %>?role=guest')" title="Guest Link">
                    üìù
                  </button>
                  <button class="btn btn-success btn-sm" onclick="copyToClipboard('<%= request.base_url %>/sessions/<%= @session.id %>?role=guest&listen=true')" title="Guest + Listen">
                    üéµ
                  </button>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Compact Add Media Form -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body py-2">
          <div data-controller="media-preview">
            <%= form_with(url: session_media_path(@session), local: true, html: { data: { controller: "media" } }) do |form| %>
              <div class="row align-items-end">
                <div class="col-md-3">
                  <label class="form-label small mb-1">üë§ Your Name</label>
                  <div class="input-group input-group-sm">
                    <%= form.text_field :added_by, 
                        class: 'form-control', 
                        required: true, 
                        placeholder: "Your name",
                        id: 'user-name-field' %>
                    <span class="input-group-text d-none" id="name-saved-indicator">‚úì</span>
                  </div>
                </div>
                <div class="col-md-7">
                  <label class="form-label small mb-1">üéµ Media URL</label>
                  <%= form.text_field :url, 
                      class: 'form-control form-control-sm', 
                      required: true, 
                      pattern: "https?://.+", 
                      placeholder: "Paste YouTube, Spotify, SoundCloud, Vimeo URL...",
                      data: { 
                        "media-preview-target" => "url",
                        "action" => "input->media-preview#showPreview"
                      } %>
                </div>
                <div class="col-md-2">
                  <%= form.submit '+ Add to Queue', class: 'btn btn-success btn-sm w-100' %>
                </div>
              </div>
              <!-- Compact Preview Area -->
              <div class="row mt-2">
                <div class="col-12">
                  <div data-media-preview-target="preview"></div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 3-Column Layout: Queue | Player | Completed -->
  <div class="row">
    <!-- Left Column: Queue -->
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0">‚è±Ô∏è Up Next (<%= @queue.count %>)</h6>
        </div>
        <div class="card-body p-2" style="max-height: 60vh; overflow-y: auto;">
          <% if @queue.any? %>
            <div id="playlist" data-playlist-id="<%= @playlist&.id %>">
              <% @queue.each do |medium| %>
                <div class="card mb-2 border-0 bg-light">
                  <div class="card-body p-2">
                    <div class="d-flex align-items-center">
                      <span class="badge bg-info me-2">#<%= medium.position %></span>
                      <div class="flex-grow-1">
                        <small class="fw-bold"><%= medium.display_title || medium.title.capitalize %></small><br>
                        <small class="text-muted">by <%= medium.added_by %></small>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-center text-muted p-3">
              <p>Queue is empty</p>
              <small>Add some media!</small>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Center Column: Player -->
    <div class="col-md-4">
      <% if @user_role == 'host' || @remote_listen %>
        <div class="card shadow-sm h-100">
          <div class="card-header bg-success text-white">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0">üéµ Now Playing</h6>
              <div id="autoplay-status">
                <button id="enable-autoplay" class="btn btn-light btn-sm" onclick="this.style.display='none'; document.getElementById('autoplay-enabled').style.display='inline'; document.querySelector('[data-controller*=autoplay]').autoplay?.startCurrentMedia()">
                  ‚ñ∂Ô∏è Enable
                </button>
                <small id="autoplay-enabled" class="text-light" style="display: none;">ü§ñ Auto</small>
              </div>
            </div>
          </div>
          <div class="card-body p-2">
            <% if @current_playing %>
              <!-- Song Info -->
              <div class="mb-2">
                <div class="d-flex align-items-center mb-2">
                  <span class="badge bg-warning text-dark me-2">#<%= @current_playing.position %></span>
                  <div>
                    <strong class="small"><%= @current_playing.display_title || @current_playing.title.capitalize %></strong><br>
                    <small class="text-muted">by <%= @current_playing.added_by %></small>
                  </div>
                </div>
              </div>
              
              <!-- Controls -->
              <% if @user_role == 'host' %>
                <div class="btn-group w-100 mb-2" role="group" data-controller="player-controls" 
                     data-player-controls-session-id-value="<%= @session.id %>"
                     data-player-controls-media-id-value="<%= @current_playing.id %>">
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="click->player-controls#restart">‚è™</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="click->player-controls#pause">‚è∏Ô∏è</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-action="click->player-controls#resume">‚ñ∂Ô∏è</button>
                  <%= button_to '‚è≠Ô∏è', play_next_session_medium_path(@session, @current_playing), method: :patch, class: 'btn btn-warning btn-sm' %>
                </div>
              <% end %>
              
              <!-- Player -->
              <div id="current-media-content" 
                   <% if @user_role == 'host' || @remote_listen %>data-controller="autoplay"<% end %>
                   data-autoplay-session-id-value="<%= @session.id %>">
                <div id="media-player" data-autoplay-target="player">
                  <%= raw @current_playing.embed_code %>
                </div>
              </div>
            <% else %>
              <div id="current-media-content" 
                   <% if @user_role == 'host' || @remote_listen %>data-controller="autoplay"<% end %>
                   data-autoplay-session-id-value="<%= @session.id %>">
                <div id="media-player" class="text-center text-muted p-4" data-autoplay-target="player">
                  <h6>No media playing</h6>
                  <small>Add some media to get started!</small>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Right Column: Recently Played -->
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-secondary text-white">
          <h6 class="mb-0">‚úÖ Recently Played</h6>
        </div>
        <div class="card-body p-2" style="max-height: 60vh; overflow-y: auto;">
          <% if @completed.any? %>
            <% @completed.last(5).reverse.each do |medium| %>
              <div class="card mb-2 border-0 bg-light">
                <div class="card-body p-2">
                  <div class="d-flex align-items-center">
                    <span class="badge bg-secondary me-2">‚úì</span>
                    <div class="flex-grow-1">
                      <small class="fw-bold"><%= medium.display_title || medium.title.capitalize %></small><br>
                      <small class="text-muted">by <%= medium.added_by %></small>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="text-center text-muted p-3">
              <p>No songs played yet</p>
              <small>They'll appear here!</small>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="row mt-5">
    <div class="col-12 text-center">
      <div class="card bg-light border-0">
        <div class="card-body py-3">
          <%= link_to 'Create New Session', new_session_path, class: 'btn btn-outline-primary' %>
          <small class="text-muted ms-3">Powered by üé¨ <strong>REEL PARTY</strong> üéµ</small>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
// Load saved name on page load
document.addEventListener('DOMContentLoaded', function() {
  const nameField = document.getElementById('user-name-field');
  const indicator = document.getElementById('name-saved-indicator');
  
  if (nameField) {
    const savedName = localStorage.getItem('reelPartyUserName');
    if (savedName) {
      nameField.value = savedName;
      if (indicator) indicator.classList.remove('d-none');
    }
    
    // Save name when it changes
    nameField.addEventListener('input', function() {
      if (this.value.trim()) {
        localStorage.setItem('reelPartyUserName', this.value.trim());
        if (indicator) indicator.classList.remove('d-none');
      } else {
        if (indicator) indicator.classList.add('d-none');
      }
    });
  }
});

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(function() {
    // Show success message
    const toast = document.createElement('div');
    toast.className = 'alert alert-success position-fixed';
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.innerHTML = '‚úÖ Link copied to clipboard!';
    document.body.appendChild(toast);
    
    setTimeout(() => {
      document.body.removeChild(toast);
    }, 2000);
  });
}
</script>
